// {{ ansible_managed }}
{# https://icinga.com/docs/icinga2/latest/doc/13-addons/#influxdb #}
{# https://icinga.com/docs/icinga2/latest/doc/14-features/#influxdb-writer #}
{# https://github.com/Icinga/icinga2/blob/master/etc/icinga2/features-available/influxdb2.conf #}

{%- set _attr = [
    'host','port','organization', 'bucket', 'auth_token', 'flush_threshold','flush_interval',
    'host_template','service_template','enable_send_thresholds','enable_send_metadata'
  ]
-%}

{% if icinga2_features.influxdb2 is defined and icinga2_features.influxdb2.host is defined %}
object Influxdb2Writer "influxdb2" {
{% if icinga2_features.influxdb2 is defined and icinga2_features.influxdb2 | count != 0 %}
{% for k, v in icinga2_features.influxdb2.items() %}
{% if k in _attr %}
{% if k in ["host", "organization", "bucket", "auth_token"] %}
  {{ k }} = "{{ v }}"
{% elif v is sameas true or v is sameas false %}
  {{ k }} = {{ v | bool | ternary('true', 'false') }}
{% elif k == "host_template" or k == "service_template" %}
  {{ k }} = {
{% for k2, v2 in v.items() | sort %}
{% if k2 == "tags" %}
    tags = {
{% for k3, v3 in v2.items() | sort %}
      {{ k3  }} = "{{ v3 }}"
{% endfor %}
    }
{% else %}
    {{ k2  }} = "{{ v2 }}"
{% endif %}
{% endfor %}
  }
{% else %}
  {{ k }} = {{ v }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %} {# 1 #}
}
{% endif %}
