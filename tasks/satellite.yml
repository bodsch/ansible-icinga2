---

- include_tasks: check_installed.yml

- name: install icinga2 packages
  package:
    name: "{{ item }}"
    state: present
  loop:
    "{{ icinga2_dependencies }}"
  when: ansible_os_family | lower != 'archlinux'

# TODO
# check for updates

- block:
    - name: download icinga2 package
      become: true
      become_user: aur_builder
      shell: |
        cd ~
        git clone https://github.com/bodsch/aur-icinga2 icinga2
        cd icinga2/
        git pull

    - name: get package version
      become: true
      become_user: aur_builder
      shell: |
        cd ~/icinga2/
        grep pkgver= PKGBUILD | awk -F '=' '{printf $2}'
      register: __packaged_icinga2_version

    - name: set package icinga2 version
      set_fact:
        packaged_icinga2_version: "{{ __packaged_icinga2_version.stdout }}"
        cacheable: true
      when: __packaged_icinga2_version is defined and __packaged_icinga2_version.rc is defined and __packaged_icinga2_version.rc == 0

    - block:
        - name: compare versiones
          debug:
            msg: current installed version {{ icinga2_installed_version }} - we need an update to version {{ packaged_icinga2_version }}

        - name: build icinga2 package
          become: true
          become_user: aur_builder
          shell: |
            cd ~/icinga2/
            makepkg --syncdeps --install --noprogressbar --noconfirm
      when: packaged_icinga2_version is version( icinga2_installed_version ,'>')

  when: (
    icinga2_use_external_repo | bool and
    ansible_os_family | lower == 'archlinux')

- include_tasks: check_installed.yml

- include: satellite/pki.yml
- include: satellite/configure.yml
- include: satellite/features.yml

# /var/lib/icinga2/api/zones-stage/startup.log
