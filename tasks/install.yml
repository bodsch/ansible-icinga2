---

- name: check installed
  include_tasks: check_installed.yml

# - name: update package cache
#   package:
#     update_cache: true

- name: based on arch linux
  block:
    - name: install icinga2 package via aur
      become: true
      become_user: aur_builder
      aur:
        state: present
        name: icinga2
        repository: "{{ icinga2_repo_archlinux }}"
      register: _icinga2_installed

    - name: install openrc init script
      template:
        src: etc/init/openrc/icinga2.j2
        dest: /etc/init.d/icinga2
        mode: 0755
      when:
        - ansible_service_mgr | lower == "openrc"

  when:
    - icinga2_use_external_repo | bool
    - ansible_os_family | lower == 'archlinux'

- name: not based on arch linux
  block:
    - name: create policy-rc.d
      copy:
        dest: /usr/sbin/policy-rc.d
        content: |
          #!/bin/sh
          exit 101
        mode: 0755

    - name: install icinga2 packages
      package:
        name: "{{ icinga2_packages }}"
        state: present
      register: _icinga2_installed

    - name: remove policy-rc.d
      file:
        path: /usr/sbin/policy-rc.d
        state: absent

  when:
    - not icinga2_installed
    - ansible_os_family | lower != 'archlinux'

...
